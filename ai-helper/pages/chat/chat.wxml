<!--èŠå¤©é¡µé¢-->
<view class="chat-container">
  <!-- èŠå¤©å¤´éƒ¨ -->
  <view class="chat-header">
    <view class="ai-avatar">
      <image src="/images/ai-teacher.png" mode="aspectFill"></image>
      <view class="status-dot online"></view>
    </view>
    <view class="ai-info">
      <view class="ai-name">AIè‹±è¯­è€å¸ˆ</view>
      <view class="ai-status">åœ¨çº¿ Â· å‡†å¤‡èŠå¤©</view>
    </view>
    <view class="header-actions">
      <button class="icon-btn" bindtap="toggleAutoVoice" title="{{autoVoiceEnabled ? 'å…³é—­è‡ªåŠ¨è¯­éŸ³' : 'å¼€å¯è‡ªåŠ¨è¯­éŸ³'}}">
        <text class="icon">{{autoVoiceEnabled ? 'ğŸ¤–' : 'ğŸ¤–'}}</text>
        <view class="status-indicator {{autoVoiceEnabled ? 'active' : 'inactive'}}"></view>
      </button>
      <button class="icon-btn" bindtap="toggleVoiceMode">
        <text class="icon">{{voiceMode ? 'ğŸ”Š' : 'ğŸ”‡'}}</text>
      </button>
      <button class="icon-btn" bindtap="showSettings">
        <text class="icon">âš™ï¸</text>
      </button>
    </view>
  </view>

  <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
  <scroll-view class="chat-messages" scroll-y="{{true}}" scroll-top="{{scrollTop}}" scroll-into-view="{{scrollIntoView}}">
    <view wx:for="{{messages}}" wx:key="id" class="message-item {{item.type}}">
      <!-- AIæ¶ˆæ¯ -->
      <view wx:if="{{item.type === 'ai'}}" class="message ai-message">
        <image class="message-avatar" src="/images/ai-teacher.png" mode="aspectFill"></image>
        <view class="message-content">
          <view class="message-bubble ai-bubble">
            <view class="message-text">{{item.text}}</view>
            <view wx:if="{{item.translation}}" class="message-translation">{{item.translation}}</view>
          </view>
          <view class="message-time">{{item.time}}</view>
        </view>
        <button wx:if="{{item.audioUrl}}" class="play-btn {{isPlayingAI ? 'playing' : ''}}" bindtap="playAudio" data-url="{{item.audioUrl}}">
          <text class="icon">{{isPlayingAI ? 'â¸ï¸' : 'ğŸ”Š'}}</text>
        </button>
      </view>

      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view wx:else class="message user-message">
        <view class="message-content">
          <view class="message-bubble user-bubble">
            <view class="message-text">{{item.text}}</view>
            <view wx:if="{{item.translation}}" class="message-translation">{{item.translation}}</view>
          </view>
          <view class="message-time">{{item.time}}</view>
        </view>
        <image class="message-avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
      </view>

      <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
      <view wx:if="{{item.type === 'system'}}" class="system-message">
        <view class="system-text">{{item.text}}</view>
      </view>
    </view>

    <!-- æ‰“å­—æŒ‡ç¤ºå™¨ -->
    <view wx:if="{{isTyping}}" class="typing-indicator">
      <image class="message-avatar" src="/images/ai-teacher.png" mode="aspectFill"></image>
      <view class="typing-bubble">
        <view class="typing-dots">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- è¯­éŸ³çŠ¶æ€æ˜¾ç¤º -->
  <view wx:if="{{isRecording}}" class="recording-status">
    <view class="recording-animation">
      <view class="wave wave1"></view>
      <view class="wave wave2"></view>
      <view class="wave wave3"></view>
    </view>
    <view class="recording-text">æ­£åœ¨å½•éŸ³...</view>
    <view class="recording-tip">æ¾å¼€ç»“æŸå½•éŸ³</view>
  </view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <!-- æ–‡æœ¬è¾“å…¥æ¨¡å¼ -->
    <view wx:if="{{!voiceMode}}" class="text-input-mode">
      <input class="text-input" 
             placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..." 
             value="{{inputText}}" 
             bindinput="onInputChange"
             bindconfirm="sendTextMessage"
             confirm-type="send" />
      <button class="send-btn" bindtap="sendTextMessage" disabled="{{!inputText.trim()}}">
        <text class="icon">ğŸ“¤</text>
      </button>
    </view>

    <!-- è¯­éŸ³è¾“å…¥æ¨¡å¼ -->
    <view wx:else class="voice-input-mode">
      <button class="voice-btn {{isRecording ? 'recording' : ''}}" 
              bindtouchstart="startRecording" 
              bindtouchend="stopRecording"
              bindtouchcancel="cancelRecording">
        <view wx:if="{{!isRecording}}" class="voice-icon">ğŸ¤</view>
        <view wx:else class="voice-icon recording">ğŸ¤</view>
        <view class="voice-text">{{isRecording ? 'æ¾å¼€ç»“æŸ' : 'æŒ‰ä½è¯´è¯'}}</view>
      </button>
    </view>

    <!-- åˆ‡æ¢æŒ‰é’® -->
    <button class="mode-switch-btn" bindtap="toggleInputMode">
      <text class="icon">{{voiceMode ? 'âŒ¨ï¸' : 'ğŸ¤'}}</text>
    </button>
  </view>

  <!-- å¿«æ·å›å¤ -->
  <view wx:if="{{showQuickReplies}}" class="quick-replies">
    <view class="quick-reply-title">å¿«æ·å›å¤ï¼š</view>
    <view class="quick-reply-list">
      <button wx:for="{{quickReplies}}" 
              wx:key="*this" 
              class="quick-reply-btn" 
              bindtap="selectQuickReply" 
              data-text="{{item}}">
        {{item}}
      </button>
    </view>
  </view>

  <!-- å­¦ä¹ æç¤º -->
  <view wx:if="{{showLearningTip}}" class="learning-tip">
    <view class="tip-content">
      <text class="tip-icon">ğŸ’¡</text>
      <text class="tip-text">{{learningTip}}</text>
    </view>
    <button class="tip-close" bindtap="closeLearningTip">Ã—</button>
  </view>
</view>
